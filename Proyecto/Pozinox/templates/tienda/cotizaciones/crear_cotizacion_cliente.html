{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Cotización para Cliente - Pozinox{% endblock %}

{% block content %}
<div class="container mt-5 pt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Crear Cotización para Cliente
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'crear_cotizacion_para_cliente' %}" id="formCrearCotizacion">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="buscar_cliente" class="form-label">
                                <i class="fas fa-search me-2"></i>Buscar Cliente
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="buscar_cliente"
                                   placeholder="Buscar por nombre, RUT o correo..."
                                   autocomplete="off">
                            <small class="form-text text-muted">
                                Ingresa el nombre, RUT o correo del cliente
                            </small>
                        </div>

                        <!-- Resultados de búsqueda -->
                        <div id="resultados_busqueda" class="mb-3" style="display: none;">
                            <div class="list-group" id="lista_clientes">
                                <!-- Los resultados se cargarán aquí dinámicamente -->
                            </div>
                        </div>

                        <!-- Cliente seleccionado -->
                        <div id="cliente_seleccionado" class="mb-4" style="display: none;">
                            <div class="alert alert-success">
                                <h6 class="alert-heading">
                                    <i class="fas fa-user-check me-2"></i>Cliente Seleccionado
                                </h6>
                                <div id="info_cliente"></div>
                                <input type="hidden" name="cliente_id" id="cliente_id">
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="btn_crear" disabled>
                                <i class="fas fa-plus-circle me-2"></i>Crear Cotización
                            </button>
                            <a href="{% url 'gestionar_estados_preparacion' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputBuscar = document.getElementById('buscar_cliente');
    const resultadosDiv = document.getElementById('resultados_busqueda');
    const listaClientes = document.getElementById('lista_clientes');
    const clienteSeleccionadoDiv = document.getElementById('cliente_seleccionado');
    const infoCliente = document.getElementById('info_cliente');
    const clienteIdInput = document.getElementById('cliente_id');
    const btnCrear = document.getElementById('btn_crear');
    let timeoutId = null;

    inputBuscar.addEventListener('input', function() {
        clearTimeout(timeoutId);
        const query = this.value.trim();

        if (query.length < 2) {
            resultadosDiv.style.display = 'none';
            return;
        }

        timeoutId = setTimeout(() => {
            fetch(`/usuarios/api/buscar-clientes/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    listaClientes.innerHTML = '';
                    
                    if (data.clientes && data.clientes.length > 0) {
                        data.clientes.forEach(cliente => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${cliente.nombre_completo || cliente.username}</h6>
                                    ${cliente.tipo_cliente === 'empresa' ? '<small><span class="badge bg-info">Empresa</span></small>' : '<small><span class="badge bg-secondary">Persona</span></small>'}
                                </div>
                                <small class="text-muted">${cliente.email || 'Sin email'}</small>
                                ${cliente.rut ? `<br><small class="text-muted">RUT: ${cliente.rut}</small>` : ''}
                            `;
                            item.addEventListener('click', function() {
                                seleccionarCliente(cliente);
                            });
                            listaClientes.appendChild(item);
                        });
                        resultadosDiv.style.display = 'block';
                    } else {
                        listaClientes.innerHTML = '<div class="list-group-item text-center text-muted">No se encontraron clientes</div>';
                        resultadosDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error al buscar clientes:', error);
                });
        }, 300);
    });

    function seleccionarCliente(cliente) {
        clienteIdInput.value = cliente.id;
        infoCliente.innerHTML = `
            <strong>${cliente.nombre_completo || cliente.username}</strong><br>
            <small>${cliente.email || 'Sin email'}</small>
            ${cliente.rut ? `<br><small>RUT: ${cliente.rut}</small>` : ''}
        `;
        clienteSeleccionadoDiv.style.display = 'block';
        resultadosDiv.style.display = 'none';
        inputBuscar.value = '';
        btnCrear.disabled = false;
    }
});
</script>

<style>
.list-group-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

#resultados_busqueda {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}
